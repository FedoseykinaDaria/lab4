{% extends "base.html" %}
{% block title %} Медицинские показатели {% endblock title %}
{% block content %}
    <p style = "font-size: 20px; font-weight: bold;">Добро пожаловать!</p>
    <p>На этом сайте вы можете добавить показатели своего здоровья или загрузить их из файла</p>
    <div class = "d-grid gap-2">    
        <a href = "{% url 'HealthForm' %}">
            <button class = 'btn btn-primary btn-lg'> Добавить запись </button>
        </a>
        <a href = "{% url 'UploadedFileForm' %}">
            <button class = 'btn btn-outline-primary btn-lg'> Загрузить файл </button>
        </a>
    </div>
    
    <div class = "d-grid col-6 mx-auto" style = "margin-top: 10px; margin-bottom: 10px;">
        <input class="form-check-input" type = "radio" name = "outputType" value = "file" checked/>
        <label> Вывод из файла </label>

        <input class="form-check-input" type = "radio" name = "outputType" value = "database"/>
        <label> Вывод из базы данных </label>
    </div>

    <p>Добавленные записи</p>
    <div class = "gap-3">
        <div id = "file_output">
            <ul class="list-group list-group-flush">
                {% for file, name in file_names.items %}
                    <li class="list-group-item"><a href="{% url 'JSONInfo' file %}">{{ name }}</a></li>
                {% empty %}
                    <p> Нет записей </p>
                {% endfor %}
            </ul>
        </div>

        <div id = "db_output" style="display: none; text-align: center;">
            <div class = "searchContainer">
                <input type = "text" id = "searchInput" placeholder = "Поиск по имени:" autocomplete = "off">
            </div>
            
            <div class = "searchResults"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function() {
        let searchTimeout;
        
        $('#searchInput').on('input', function() {
            const query = $(this).val();

            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(function() {
                NotesSearch(query);
            }, 500);
        });

        function NotesSearch(query){
            $.ajax({
                url: '{% url "DBSearch" %}',
                type: 'GET',
                data:{
                    'query': query
                },
                headers:{
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response){
                    if (response.success  && response.searched_notes){
                        updateNotes(response.searched_notes);
                    }
                    else{
                        $('.searchResults').html('<div><p>Ошибка при поиске</p></div>');   
                    }
                },
                error: function(){
                    $('.searchResults').html('<div><p>Ошибка соединения</p></div>');
                }
            })
        }
        function updateNotes(searched_notes){
            if (!searched_notes || searched_notes.length == 0){
                $('.searchResults').html('<div><p>К сожалению, мы ничего не нашли. Время добавить новые записи!</p></div>');
                return;
            }

            let html = '<ul class="list-group list-group-flush">';
            searched_notes.forEach(function(note) {
                note_url = `/showDB/${ note.id }/`;
                html += `
                        <li class="list-group-item"><a href='${ note_url }'>${ note.name }</a></li>
                `;
            });
            html += '</ul>'
            
            $('.searchResults').html(html);
        }
        
        
        document.querySelectorAll('input[type="radio"][name="outputType"]').forEach(radio =>{
            radio.addEventListener('change', function(){
                if (radio.value == "database"){
                    document.getElementById("file_output").style.display = 'none';
                    document.getElementById("db_output").style.display = 'block';

                    NotesSearch('');
                }
                else{
                    document.getElementById("file_output").style.display = 'block';
                    document.getElementById("db_output").style.display = 'none';
                }
            });
        });
    });
    </script>
{% endblock content%}